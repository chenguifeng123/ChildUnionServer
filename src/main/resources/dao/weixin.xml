<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.qinzi123.dao.WeixinDao" >


	<sql id="left_join_card_and_tag">
		from card_info t left join
			(select card_id, max(tag1) as tag1, max(tag2) as tag2, max(tag3) as tag3 from
				(select card_id, tag_name as tag1, '' as tag2, '' as tag3 from card_tag a, tag_service_info b where tag1 = tag_id
				UNION all
				select card_id, '' as tag1, tag_name as tag2, '' as tag3 from card_tag a, tag_service_info b where tag2 = tag_id
				union ALL
				select card_id, '' as tag1, '' as tag2, tag_name as tag3 from card_tag a, tag_service_info b where tag3 = tag_id
				) m group by card_id ) s
		on t.id = s.card_id
	</sql>

	<!-- 获取商户列表 -->
	<select id="listBusiness" resultType="java.util.LinkedHashMap">
		select id, headimgurl, realname, job, company, tag1, tag2, tag3, case when follower_id is null  then 0 else 1 end as isFollow
		<include refid="left_join_card_and_tag"/>
		left join (select follower_id from follower where user_id = #{id}) x on t.id = x.follower_id
    </select>

	<!-- 获取商户列表 -->
	<select id="oneBusiness" resultType="java.util.LinkedHashMap">
		select id, headimgurl, realname, job, company, phone, workaddress, introduce,
		tag1, tag2, tag3, follow_count,fans_count
		<include refid="left_join_card_and_tag"/>,
     (select count(*) as follow_count from follower where user_id = #{id}) u,
     (select count(*) as fans_count from follower where follower_id = #{id}) v
  where t.id = #{id}
	</select>


	<insert id="addFollower" useGeneratedKeys="true" parameterType="com.qinzi123.dto.Follower">
		insert into follower(user_id, follower_id) values(#{userId}, #{followerId})
	</insert>
	
</mapper>